<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantifyre Iris - Add Campaign</title>
    <link rel="stylesheet" href="Css/style.css">
    <link rel="stylesheet" href="Css/sidebar.css">
    <link href="Css/fontstyle.css" rel="stylesheet">
    <link rel="stylesheet" href="Css/all.css">
    <link rel="stylesheet" href="Css/dateflatpickr.min.css">
    <link rel="stylesheet" href="Css/datestyle.css">
    <link rel="stylesheet" href="Css/clientnamedropdown.css" />
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdoAp_bGW4T01O0KJNp-CfRr8geeuasOY&libraries=places,drawing"></script>

</head>

<body>

    <div class="dashboard-container">

        <aside class="sidebar">
            <div class="close-sidebar-btn" id="closeSidebarBtn">
                <i class="fa-solid fa-xmark"></i>
            </div>

            <div class="logo-section">
                <div class="logo-icon">
                    <img src="Images/quantifirelogo.png" alt="Quantifyre">
                </div>
            </div>

            <div class="user-mini-profile">
                <div class="avatar-circle">
                    <img src="Images/ClientSlider.ico">
                </div>
                <p>Agency Name</p>
            </div>

            <nav>
                <ul>
                    <li><a href="AgencyDashboard.html"><img src="Images/Dashboard30x30.ico"> Dashboard</a></li>
                    <li><a href="Clients.html"><img src="Images/Clients30x30.ico"> Client</a></li>
                    <li class="active"><a href="Campaigns.html"><img src="Images/Campaign30x30.ico"> Campaigns</a></li>
                    <li><a href="Leads.html"><img src="Images/Leads30x30.ico"> Leads</a></li>
                    <li><a href="Locations.html"><img src="Images/Locations30x30.ico"> Locations</a></li>
                    <li><a href="Report&Analytics.html"><img src="Images/Report&Analytics.ico"> Report & Analytics</a>
                    </li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">

            <header class="top-bar">
                <div class="menu-toggle" id="sidebarToggle"><img src="Images/Slide.ico"></div>
                <div class="search-bar">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" placeholder="Search campaigns, leads, locations...">
                </div>
                <div class="top-profile-actions" style="position: relative;">
                    <div class="notification-wrapper" style="position: relative;">
                        <div class="icon-btn notification" onclick="toggleNotification(event)">
                            <img src="Images/Notifications.ico">
                            <span class="notif-count">3</span>
                        </div>
                        <div class="notif-dropdown" id="notifDropdown">
                            <div class="notif-header">
                                <h4>Notifications</h4><span class="mark-read">Mark all read</span>
                            </div>
                            <ul class="notif-list">
                                <li class="notif-item unread">
                                    <div class="n-icon success"><i class="fa-solid fa-check"></i></div>
                                    <div class="n-text">
                                        <p><strong>Campaign Approved</strong></p><span>"Summer Sale" is live.</span>
                                    </div>
                                    <span class="n-time">2m</span>
                                </li>
                                <li class="notif-item unread">
                                    <div class="n-icon info"><i class="fa-solid fa-user-plus"></i></div>
                                    <div class="n-text">
                                        <p><strong>New Lead</strong></p><span>John Doe from Ahmedabad.</span>
                                    </div>
                                    <span class="n-time">1h</span>
                                </li>
                                <li class="notif-item">
                                    <div class="n-icon warning"><i class="fa-solid fa-triangle-exclamation"></i></div>
                                    <div class="n-text">
                                        <p><strong>Budget Alert</strong></p><span>90% budget used.</span>
                                    </div>
                                    <span class="n-time">1d</span>
                                </li>
                            </ul>
                            <div class="notif-footer"><a href="#">View All Notifications</a></div>
                        </div>
                    </div>
                    <div class="profile-info" onclick="toggleProfileDropdown(event)"
                        style="cursor: pointer; display: flex; align-items: center; gap: 10px;">
                        <div class="avatar-small"><img src="Images/ClientHeader.ico"></div>
                        <div class="text-info">
                            <h4>Agency Name</h4>
                            <p>Agency</p>
                        </div>
                        <i class="fa-solid fa-chevron-down" id="profileChevron" style="transition: 0.3s;"></i>
                    </div>
                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="dropdown-header-info">
                            <p class="d-name">Agency Name</p><span class="d-email">agency@quantifyre.com</span>
                        </div>
                        <ul class="dropdown-list">
                            <li><a href="Settings.html"><i class="fa-solid fa-gear"></i> Settings</a></li>
                            <div class="dropdown-divider"></div>
                            <li><a href="javascript:void(0)" onclick="openLogoutModal()"><i
                                        class="fa-solid fa-arrow-right-from-bracket"></i> Logout</a></li>
                        </ul>
                    </div>
                </div>
            </header>

            <div class="page-header">
                <div class="title-text">
                    <div class="icon-square"><img src="Images/Campaign50x50.ico" alt=""></div>
                    <div>
                        <h1>Add New Campaign</h1>
                        <p>Create a new campaign and monitor insights in real time</p>
                    </div>
                </div>
            </div>

            <div class="glass-card form-container">
                <form action="#" method="POST">
                    <div class="form-grid-2">
                        <div class="form-group">
                            <label for="campaignName">Campaign Name</label>
                            <input type="text" id="campaignName" class="form-input"
                                placeholder="Enter your campaign name">
                            <span id="campaignNameErr" class="error-msg">* This field is required</span>
                        </div>
                        <div class="form-group">
                            <label for="clientName">Client Name</label>
                            <select id="clientName" class="search-input-field">
                                <option value="" disabled selected></option>
                            </select>
                            <span id="clientNameErr" class="error-msg">* Please select a valid client</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="targetLocation">Target Location</label>
                        <textarea id="targetLocation" class="form-input" rows="4"
                            placeholder="Describe your location..."
                            onkeydown="if(/[0-9]/.test(event.key)) event.preventDefault();"
                            oninput="this.value = this.value.replace(/[0-9]/g, '')"></textarea>
                        <span id="targetLocationErr" class="error-msg">* This field is required</span>
                    </div>

                    <div class="form-grid-4">
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <div class="date-wrapper">
                                <input type="text" id="startDate" class="form-input" placeholder="Select Start Date">
                                <i class="fa-regular fa-calendar"></i>
                            </div>
                            <span id="startDateErr" class="error-msg">* Required</span>
                        </div>
                        <div class="form-group">
                            <label for="endDate">End Date</label>
                            <div class="date-wrapper">
                                <input type="text" id="endDate" class="form-input" placeholder="Select End Date">
                                <i class="fa-regular fa-calendar"></i>
                            </div>
                            <span id="endDateErr" class="error-msg">* Required</span>
                        </div>
                        <div class="form-group">
                            <label for="budget">Campaign Budget (â‚¹)</label>
                            <input type="number" id="budget" class="form-input" placeholder="Total budget">
                            <span id="budgetErr" class="error-msg">* Required</span>
                        </div>
                        <div class="form-group">
                            <label for="leads">Leads</label>
                            <input type="number" id="leads" class="form-input" placeholder="Total Leads">
                            <span id="leadsErr" class="error-msg">* Required</span>
                        </div>
                    </div>

                    <div class="form-grid-4">
                        <div class="form-group">
                            <label>Gender Filter</label>
                            <div class="custom-dropdown" id="genderDropdown">
                                <div class="dropdown-selected" onclick="toggleDropdown('genderDropdown')">
                                    <span class="selected-text">Select Gender</span>
                                    <i class="fa-solid fa-chevron-down" style="font-size: 0.8rem;"></i>
                                </div>
                                <ul class="dropdown-options">
                                    <li class="dropdown-item" onclick="selectItem('genderDropdown', 'All')">All</li>
                                    <li class="dropdown-item" onclick="selectItem('genderDropdown', 'Male')">Male</li>
                                    <li class="dropdown-item" onclick="selectItem('genderDropdown', 'Female')">Female
                                    </li>
                                </ul>
                                <input type="hidden" id="selectedGenderValue">
                            </div>
                            <span id="genderErr" class="error-msg">* Please select gender</span>
                        </div>
                        <div class="form-group">
                            <label for="ageRange">Age Range</label>
                            <input type="text" id="ageRange" class="form-input" placeholder="e.g., 18-45">
                            <span id="ageRangeErr" class="error-msg">* Required</span>
                        </div>
                        <div class="form-group">
                            <label>Campaign Status</label>
                            <div class="custom-dropdown" id="statusDropdown">
                                <div class="dropdown-selected" onclick="toggleDropdown('statusDropdown')">
                                    <span class="selected-text">Active</span>
                                    <i class="fa-solid fa-chevron-down" style="font-size: 0.8rem;"></i>
                                </div>
                                <ul class="dropdown-options">
                                    <li class="dropdown-item" onclick="selectItem('statusDropdown', 'Active')">Active
                                    </li>
                                    <li class="dropdown-item" onclick="selectItem('statusDropdown', 'Paused')">Paused
                                    </li>
                                    <li class="dropdown-item" onclick="selectItem('statusDropdown', 'Completed')">
                                        Completed</li>
                                </ul>
                                <input type="hidden" name="status" id="selectedStatusValue">
                            </div>
                            <span id="statusErr" class="error-msg">* Please select a status</span>
                        </div>
                        <div class="form-group">
                            <label for="conversions">Total Conversions</label>
                            <input type="number" id="conversions" class="form-input" placeholder="e.g., 150">
                            <span id="conversionsErr" class="error-msg">* Required</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Geo-Fence & Platform</label>

                        <div class="map-platform-container" style="display: flex; gap: 20px;">
                            <div style="width: 70%;">

                                <div style="margin-bottom: 10px;">
                                    <div class="map-toolbar-overlay"
                                        style="left: 0; position: static; display: flex; gap: 8px; background: rgba(11, 22, 21, 0.6); padding: 8px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); width: 100%;">
                                        <div class="map-dropdown" id="shapeDropdown">
                                            <div class="map-dd-trigger" onclick="toggleMapDropdown(event)">
                                                <span id="selectedToolText"><i class="far fa-circle"></i> Circle</span>
                                                <i class="fas fa-chevron-down" style="font-size: 0.7rem;"></i>
                                            </div>
                                            <ul class="map-dd-menu">
                                                <li class="map-dd-item" onclick="selectTool('circle', 'Circle')"><i
                                                        class="far fa-circle"></i> Circle</li>
                                                <li class="map-dd-item" onclick="selectTool('rectangle', 'Rectangle')">
                                                    <i class="far fa-square"></i> Rectangle
                                                </li>
                                                <li class="map-dd-item" onclick="selectTool('polygon', 'Polygon')"><i
                                                        class="fas fa-draw-polygon"></i> Polygon</li>
                                            </ul>
                                        </div>
                                        <input type="text" id="customSearchInput" class="map-input"
                                            placeholder="City name..." onkeypress="handleEnter(event)">
                                        <button type="button" class="btn-icon btn-search" id="searchBtn"
                                            onclick="performDirectSearch()"><i class="fas fa-search"></i></button>
                                        <input type="number" id="radiusInput" class="map-input" placeholder="Rad(m)"
                                            onkeypress="handleEnter(event)">
                                        <button type="button" class="btn-icon btn-check" onclick="applyFilter()"><i
                                                class="fas fa-check"></i></button>
                                        <button type="button" class="btn-icon btn-clear" onclick="clearMap()"><i
                                                class="fas fa-trash-alt"></i></button>
                                    </div>
                                </div>

                                <div class="map-input-wrapper" id="mapWrapper"
                                    style="  border-radius: 12px;  border: 1px solid rgba(255,255,255,0.1);">

                                    <div id="campaignMap" style="height: 100%; width: 100%;"></div>
                                </div>
                            </div>

                            <div class="platform-selection-box" id="platformBox"
                                style="flex: 1; background: rgba(11, 22, 21, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; gap: 15px;">
                                <h4
                                    style="color: #00ff9d; font-size: 0.9rem; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px;">
                                    Ad Platform</h4>

                                <label class="platform-option">
                                    <input type="checkbox" name="adPlatform" value="google" id="adPlatformGoogle">
                                    <div class="platform-card">
                                        <i class="fa-brands fa-google"></i>
                                        <span>Google Ads</span>
                                        <i class="fa-solid fa-circle-check check-mark"></i>
                                    </div>
                                </label>

                                <label class="platform-option">
                                    <input type="checkbox" name="adPlatform" value="meta" id="adPlatformMeta">
                                    <div class="platform-card">
                                        <i class="fa-brands fa-facebook-f"></i>
                                        <span>Facebook Meta</span>
                                        <i class="fa-solid fa-circle-check check-mark"></i>
                                    </div>
                                </label>
                                <span id="platformErr" class="error-msg">* Select at least one platform</span>
                            </div>
                        </div>
                        <span id="mapErr" class="error-msg">* Please mark a location on the map</span>
                    </div>

                    <div class="form-group">
                        <label>Upload Creatives</label>
                        <div class="upload-zone">
                            <input type="file" class="drop-zone-input" multiple>
                            <div class="upload-content">
                                <i class="fa-solid fa-cloud-arrow-up"></i>
                                <p>Choose a file or drag & drop it here</p>
                            </div>
                        </div>
                        <span id="imageErr" class="error-msg">* Please upload at least one creative image</span>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="saveCampaignBtn" class="btn btn-add">Add Campaign</button>
                        <a href="Campaigns.html" style="text-decoration: none;" type="button" class="btn btn-cancel"
                            onclick="history.back()">Cancel</a>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <div class="modal-overlay1" id="logoutModal">
        <div class="modal-content1">
            <div class="modal-icon-box2">
                <i class="fa-solid fa-arrow-right-from-bracket"></i>
            </div>
            <h2>Ready to Leave?</h2>
            <p>Are you sure you want to logout? You will need to login again to access your dashboard.</p>
            <div class="modal-actions1">
                <button class="btn-modal1 btn-modal-cancel1" onclick="closeLogoutModal()">Cancel</button>
                <button class="btn-modal1 btn-modal-delete1" onclick="confirmLogout()">Logout</button>
            </div>
        </div>
    </div>

    <script src="Js/jquery-3.7.1.min.js"></script>
    <script src="Js/flatpickr.js"></script>
    <script src="Js/allagency.js"></script>
    <script src="Js/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        // 1. Global Variables
        var map, drawingManager, currentMarker;
        var overlays = [];

        $(document).ready(function () {

            // --- A. INITIALIZE DATE PICKERS ---
            const startPicker = flatpickr("#startDate", {
                dateFormat: "d M, Y",
                altInput: true,
                altFormat: "d M, Y",
                theme: "dark",
                minDate: "today",
                onChange: function (selectedDates, dateStr) {
                    endPicker.set('minDate', dateStr);
                }
            });

            const endPicker = flatpickr("#endDate", {
                dateFormat: "d M, Y",
                altInput: true,
                altFormat: "d M, Y",
                theme: "dark",
                minDate: "today"
            });

            // --- B. INITIALIZE SELECT2 ---
            $('#clientName').select2({
                placeholder: "Type to search client...",
                allowClear: true,
                width: '100%'
            });

            // --- C. INITIALIZE MAP & LOAD CLIENTS ---
            initMap();
            loadClientsList();

            // --- D. VALIDATION CLEANUP ---
            $("#targetLocation").on("input", function () {
                this.value = this.value.replace(/[0-9]/g, '');
            });

            $('#clientName').on('select2:select', function (e) {
                $("#clientNameErr").hide();
                $(this).next(".select2-container").find(".select2-selection").css("border", "1px solid rgba(255, 255, 255, 0.1)");
            });

            // --- E. SAVE CAMPAIGN MAIN LOGIC ---
            $("#saveCampaignBtn").click(function (e) {
                e.preventDefault();

                $(".error-msg").hide();
                $(".form-input, .custom-dropdown, #mapWrapper, #platformBox, .upload-zone").css("border", "1px solid rgba(255, 255, 255, 0.1)");

                let isValid = true;

                if ($("#campaignName").val().trim() === "") { $("#campaignNameErr").show(); $("#campaignName").css("border", "1px solid red"); isValid = false; }
                if ($("#targetLocation").val().trim() === "") { $("#targetLocationErr").show(); $("#targetLocation").css("border", "1px solid red"); isValid = false; }
                if ($("#budget").val().trim() === "") { $("#budgetErr").show(); $("#budget").css("border", "1px solid red"); isValid = false; }
                if ($("#startDate").val().trim() === "") { $("#startDateErr").show(); $("#startDate").parent().css("border", "1px solid red"); isValid = false; }
                if ($("#endDate").val().trim() === "") { $("#endDateErr").show(); $("#endDate").parent().css("border", "1px solid red"); isValid = false; }
                if ($("#leads").val().trim() === "") { $("#leadsErr").show(); $("#leads").css("border", "1px solid red"); isValid = false; }
                if ($("#ageRange").val().trim() === "") { $("#ageRangeErr").show(); $("#ageRange").css("border", "1px solid red"); isValid = false; }
                if ($("#conversions").val().trim() === "") { $("#conversionsErr").show(); $("#conversions").css("border", "1px solid red"); isValid = false; }

                let clientVal = $("#clientName").val();
                if (!clientVal) {
                    $("#clientNameErr").show();
                    $("#clientName").next(".select2-container").find(".select2-selection").css("border", "1px solid #ff4d4d");
                    isValid = false;
                }

                if ($("#selectedGenderValue").val() === "") { $("#genderErr").show(); $("#genderDropdown").css("border", "1px solid red"); isValid = false; }
                if ($("#selectedStatusValue").val() === "") { $("#statusErr").show(); $("#statusDropdown").css("border", "1px solid red"); isValid = false; }

                var mapData = getGeoFenceData();
                if (!mapData) { $("#mapErr").show(); $("#mapWrapper").css("border", "1px solid red"); isValid = false; }

                if ($('input[name="adPlatform"]:checked').length === 0) { $("#platformErr").show(); $("#platformBox").css("border", "1px solid red"); isValid = false; }

                var fileInput = $(".drop-zone-input")[0];
                if (fileInput.files.length === 0) {
                    $("#imageErr").show();
                    $(".upload-zone").css("border", "1px solid red");
                    isValid = false;
                }

                if (!isValid) {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    return false;
                }

                var selectedPlatforms = [];
                $('input[name="adPlatform"]:checked').each(function () {
                    selectedPlatforms.push($(this).val());
                });

                var campaignObj = {
                    campaignName: $("#campaignName").val().trim(),
                    clientName: $("#clientName").val().trim(),
                    targetLocation: $("#targetLocation").val().trim(),
                    startDate: $("#startDate").val(),
                    endDate: $("#endDate").val(),
                    budget: $("#budget").val(),
                    leads: $("#leads").val(),
                    totalConversions: $("#conversions").val(),
                    gender: $("#selectedGenderValue").val(),
                    ageRange: $("#ageRange").val(),
                    status: $("#selectedStatusValue").val() || "Active",
                    geoData: JSON.stringify(mapData),
                    adPlatform: selectedPlatforms.join(",")
                };

                var formData = new FormData();
                formData.append("campaignData", JSON.stringify(campaignObj));
                if (fileInput.files.length > 0) {
                    formData.append("image", fileInput.files[0]);
                }

                var $btn = $(this);
                $btn.text("Saving...").prop("disabled", true);

                $.ajax({
                    url: "https://quantifire-iris-backend.onrender.com/api/agency/campaigns/add",
                    type: "POST",
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function (response) {
                        alert("Campaign Saved Successfully!");
                        window.location.href = "Campaigns.html";
                    },
                    error: function (xhr) {
                        alert("Error: " + (xhr.responseText || "Server Error"));
                    },
                    complete: function () {
                        $btn.text("Add Campaign").prop("disabled", false);
                    }
                });
            });
        });

        // --- 2. HELPER FUNCTIONS ---

        function loadClientsList() {
            $.ajax({
                url: "https://quantifire-iris-backend.onrender.com/api/agency/clients/all",
                type: "GET",
                success: function (data) {
                    let dropdown = $('#clientName');
                    data.forEach(client => {
                        let name = client.clientName || client.client_name;
                        if (name) {
                            let newOption = new Option(name, name, false, false);
                            dropdown.append(newOption).trigger('change');
                        }
                    });
                }
            });
        }

        function toggleDropdown(id) {
            $('.custom-dropdown').not('#' + id).removeClass('active');
            $('#' + id).toggleClass('active');
        }

        function selectItem(dropdownId, text) {
            var dropdown = $('#' + dropdownId);
            dropdown.find('.selected-text').text(text);
            dropdown.removeClass('active');
            if (dropdownId === 'genderDropdown') $('#selectedGenderValue').val(text);
            if (dropdownId === 'statusDropdown') $('#selectedStatusValue').val(text);
        }

        // --- GOOGLE MAPS FUNCTIONS ---
        function initMap() {
            map = new google.maps.Map(document.getElementById("campaignMap"), {
                center: { lat: 20.5937, lng: 78.9629 },
                zoom: 5,
                styles: [
                    { elementType: "geometry", stylers: [{ color: "#091815" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#091815" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
                    { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] },
                    { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] }
                ]
            });

            const input = document.getElementById("customSearchInput");
            const autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.bindTo("bounds", map);

            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (!place.geometry) return;
                if (place.geometry.viewport) map.fitBounds(place.geometry.viewport);
                else { map.setCenter(place.geometry.location); map.setZoom(15); }
                if (currentMarker) currentMarker.setMap(null);
                currentMarker = new google.maps.Marker({ position: place.geometry.location, map: map });
            });

            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: null,
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: ['circle', 'polygon', 'rectangle']
                },
                circleOptions: { fillColor: "#00ffaa", fillOpacity: 0.2, strokeColor: "#00ffaa", editable: true },
                rectangleOptions: { fillColor: "#00ffaa", fillOpacity: 0.2, strokeColor: "#00ffaa", editable: true },
                polygonOptions: { fillColor: "#00ffaa", fillOpacity: 0.2, strokeColor: "#00ffaa", editable: true }
            });
            drawingManager.setMap(map);

            google.maps.event.addListener(drawingManager, 'overlaycomplete', function (event) {
                clearOverlays();
                overlays.push(event.overlay);
            });
        }

        function clearOverlays() {
            for (var i = 0; i < overlays.length; i++) { overlays[i].setMap(null); }
            overlays = [];
        }

        function clearMap() {
            clearOverlays();
            if (currentMarker) currentMarker.setMap(null);
            $('#customSearchInput').val('');
            map.setCenter({ lat: 20.5937, lng: 78.9629 });
            map.setZoom(5);
        }

        function getGeoFenceData() {
            if (overlays.length === 0) return null;
            let shape = overlays[0];
            if (shape instanceof google.maps.Circle) {
                return { type: "Circle", lat: shape.getCenter().lat(), lng: shape.getCenter().lng(), radius: shape.getRadius() };
            } else if (shape instanceof google.maps.Rectangle) {
                return { type: "Rectangle", bounds: shape.getBounds().toJSON() };
            } else if (shape instanceof google.maps.Polygon) {
                return { type: "Polygon", path: shape.getPath().getArray() };
            }
            return null;
        }

        // --- UPLOAD IMAGE PREVIEW ---
        $(document).on('change', '.drop-zone-input', function () {
            const file = this.files[0];
            const uploadZone = $(this).closest('.upload-zone');
            const uploadContent = uploadZone.find('.upload-content');
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    uploadZone.find('.preview-img').remove();
                    uploadContent.hide();
                    uploadZone.append(`<img src="${e.target.result}" class="preview-img" style="max-height: 100%; max-width: 100%; object-fit: contain; border-radius: 10px;">`);
                };
                reader.readAsDataURL(file);
            }
        });

        // Dropdown kholne aur band karne ke liye
        function toggleMapDropdown(event) {
            event.stopPropagation();
            $('#shapeDropdown').toggleClass('active');
        }

        // Tool select karne ke liye (Circle, Rectangle, Polygon)
        function selectTool(toolType, toolName) {
            // Dropdown text update karein
            let iconClass = toolType === 'circle' ? 'far fa-circle' :
                toolType === 'rectangle' ? 'far fa-square' : 'fas fa-draw-polygon';

            $('#selectedToolText').html(`<i class="${iconClass}"></i> ${toolName}`);

            // Drawing manager ka mode change karein
            if (toolType === 'circle') {
                drawingManager.setDrawingMode(google.maps.drawing.OverlayType.CIRCLE);
            } else if (toolType === 'rectangle') {
                drawingManager.setDrawingMode(google.maps.drawing.OverlayType.RECTANGLE);
            } else if (toolType === 'polygon') {
                drawingManager.setDrawingMode(google.maps.drawing.OverlayType.POLYGON);
            }

            $('#shapeDropdown').removeClass('active');
        }

        $(document).on('click', function () {
            $('#shapeDropdown').removeClass('active');
        });

        $(document).on('click', function (e) {
            // 1. Map Shape Dropdown handle 
            if (!$(e.target).closest('#shapeDropdown').length) {
                $('#shapeDropdown').removeClass('active');
            }

            if (!$(e.target).closest('.custom-dropdown').length) {
                $('.custom-dropdown').removeClass('active');
            }
        });

        function toggleMapDropdown(event) {
            event.stopPropagation();
            $('#shapeDropdown').toggleClass('active');
            $('.custom-dropdown').removeClass('active');
        }

        function toggleDropdown(id) {
            event.stopPropagation();
            $('.custom-dropdown').not('#' + id).removeClass('active');
            $('#shapeDropdown').removeClass('active');
            $('#' + id).toggleClass('active');
        }

    </script>
</body>

</html>
