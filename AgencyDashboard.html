<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantifyre Iris - Agency Dashboard</title>
    <link rel="stylesheet" href="Css/style.css">
    <link rel="stylesheet" href="Css/sidebar.css">
    <link href="Css/fontstyle.css" rel="stylesheet">
    <link rel="stylesheet" href="Css/all.css">
    <script src="Js/chart.js"></script>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdoAp_bGW4T01O0KJNp-CfRr8geeuasOY&libraries=places,drawing"></script>

</head>

<body>

    <div class="dashboard-container">

        <aside class="sidebar">
            <div class="close-sidebar-btn" id="closeSidebarBtn">
                <i class="fa-solid fa-xmark"></i>
            </div>
            <div class="logo-section">
                <div class="logo-icon">
                    <img src="Images/quantifirelogo.png" alt="">
                </div>
            </div>

            <div class="user-mini-profile">
                <div class="avatar-circle">
                    <img src="Images/ClientSlider.ico">
                </div>
                <p>Agency Name</p>
            </div>

            <nav>
                <ul>
                    <li class="active"><a href="AgencyDashboard.html"><img src="Images/Dashboard30x30.ico">
                            Dashboard</a></li>
                    <li><a href="Clients.html"><img src="Images/Clients30x30.ico"> Client</a></li>
                    <li><a href="Campaigns.html"><img src="Images/Campaign30x30.ico"> Campaigns</a></li>
                    <li><a href="Leads.html"><img src="Images/Leads30x30.ico"> Leads</a></li>
                    <li><a href="Locations.html"><img src="Images/Locations30x30.ico"> Locations</a></li>
                    <li><a href="Report&Analytics.html"><img src="Images/Report&Analytics.ico"> Report & Analytics</a>
                    </li>

                    <div class="mobile-only-menu">
                        <li><a href="Settings.html"><img src="Images/Setting30x30.ico"> Settings</a></li>
                        <div class="dropdown-divider"
                            style="margin: 10px 25px; border-bottom: 1px solid rgba(255,255,255,0.1);"></div>
                        <li><a href="javascript:void(0)" onclick="openLogoutModal()"><i
                                    class="fa-solid fa-arrow-right-from-bracket"></i> Logout</a></li>
                    </div>
                </ul>
            </nav>
        </aside>

        <main class="main-content">

            <header class="top-bar">
                <div class="menu-toggle" id="sidebarToggle"><img src="Images/Slide.ico"></div>

                <div class="search-bar">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" id="globalSearchInput" placeholder="Search campaigns, clients..."
                        autocomplete="off">
                    <ul class="suggestion-box" id="globalSuggestionList"></ul>
                </div>

                <div class="top-profile-actions" style="position: relative;">
                    <div class="notification-wrapper" style="position: relative;">
                        <div class="icon-btn notification" onclick="toggleNotification(event)">
                            <img src="Images/Notifications.ico">
                            <span class="notif-count">3</span>
                        </div>
                        <div class="notif-dropdown" id="notifDropdown">
                            <div class="notif-header">
                                <h4>Notifications</h4><span class="mark-read">Mark all read</span>
                            </div>
                            <ul class="notif-list">
                                <li class="notif-item unread">
                                    <div class="n-icon success"><i class="fa-solid fa-check"></i></div>
                                    <div class="n-text">
                                        <p><strong>Campaign Approved</strong></p><span>"Summer Sale" is live.</span>
                                    </div>
                                    <span class="n-time">2m</span>
                                </li>
                                <li class="notif-item unread">
                                    <div class="n-icon info"><i class="fa-solid fa-user-plus"></i></div>
                                    <div class="n-text">
                                        <p><strong>New Lead</strong></p><span>John Doe from Ahmedabad.</span>
                                    </div>
                                    <span class="n-time">1h</span>
                                </li>
                                <li class="notif-item">
                                    <div class="n-icon warning"><i class="fa-solid fa-triangle-exclamation"></i></div>
                                    <div class="n-text">
                                        <p><strong>Budget Alert</strong></p><span>90% budget used.</span>
                                    </div>
                                    <span class="n-time">1d</span>
                                </li>
                            </ul>
                            <div class="notif-footer"><a href="#">View All Notifications</a></div>
                        </div>
                    </div>
                    <div class="profile-info" onclick="toggleProfileDropdown(event)"
                        style="cursor: pointer; display: flex; align-items: center; gap: 10px;">
                        <div class="avatar-small"><img src="Images/ClientHeader.ico"></div>
                        <div class="text-info">
                            <h4>Agency Name</h4>
                            <p>Agency</p>
                        </div>
                        <i class="fa-solid fa-chevron-down" id="profileChevron" style="transition: 0.3s;"></i>
                    </div>
                    <div class="profile-dropdown" id="profileDropdown">
                        <div class="dropdown-header-info">
                            <p class="d-name">Agency Name</p><span class="d-email">agency@quantifyre.com</span>
                        </div>
                        <ul class="dropdown-list">
                            <li><a href="Settings.html"><i class="fa-solid fa-gear"></i> Settings</a></li>
                            <div class="dropdown-divider"></div>
                            <li><a href="javascript:void(0)" onclick="openLogoutModal()"><i
                                        class="fa-solid fa-arrow-right-from-bracket"></i> Logout</a></li>
                        </ul>
                    </div>
                </div>
            </header>

            <div class="page-header" style="margin-bottom: 20px;">
                <div class="title-text">
                    <div class="icon-square">
                        <img src="Images/Agency50x50.ico">
                    </div>
                    <div>
                        <h1>Agency Dashboard</h1>
                        <p>Manage campaigns clients,and performance insights.</p>
                    </div>
                </div>
            </div>

            <section class="stats-grid">
                <div class="stat-card" id="statcard1">
                    <div class="card-header">
                        <div class="icon-box icon-cyan">
                            <img src="Images/Campaign50x50.ico">
                        </div>
                        <span class="percent up"><i class="fa-solid fa-arrow-up"></i> 12%</span>
                    </div>
                    <h2>99</h2>
                    <p>Total Campaigns Running</p>
                </div>

                <div class="stat-card" id="statcard2">
                    <div class="card-header">
                        <div class="icon-box icon-green">
                            <img src="Images/Leads50x50.ico">
                        </div>
                        <span class="percent up"><i class="fa-solid fa-arrow-up"></i> 8%</span>
                    </div>
                    <h2>2356</h2>
                    <p>Total Leads Generated</p>
                </div>

                <div class="stat-card" id="statcard3">
                    <div class="card-header">
                        <div class="icon-box icon-blue">
                            <img src="Images/Customer50x50.ico">
                        </div>
                        <span class="percent up"><i class="fa-solid fa-arrow-up"></i> 15%</span>
                    </div>
                    <h2>650</h2>
                    <p>Total Active Clients</p>
                </div>

                <div class="stat-card" id="statcard4">
                    <div class="card-header">
                        <div class="icon-box icon-dark-blue">
                            <img src="Images/Reports&Leads.ico">
                        </div>
                        <span class="percent up"><i class="fa-solid fa-arrow-up"></i> 5%</span>
                    </div>
                    <h2>170</h2>
                    <p>Report Downloaded</p>
                </div>
            </section>

            <section class="agency-mid-grid">

                <div class="chart-container" style="height: 450px;">
                    <h3> Leads by Source</h3>
                    <div class="chart-wrapper pie-wrapper">
                        <canvas id="sourceChart"></canvas>
                    </div>
                    <div class="pie-legend">
                        <span><i class="fa-solid fa-circle" style="color: #00ffaa;"></i> Google Ads</span>
                        <span><i class="fa-solid fa-circle" style="color: #ffcc00;"></i> Facebook</span>
                        <span><i class="fa-solid fa-circle" style="color: #ff6b6b;"></i> Instagram</span>
                        <span><i class="fa-solid fa-circle" style="color: #00d4ff;"></i> Whatsapp</span>
                    </div>
                </div>

                <div class="map-card">
                    <h3>Geofence Map</h3>

                    <div class="map-toolbar-inner">
                        <input type="text" id="customSearchInput" class="map-input" placeholder="City name..."
                            onkeypress="handleEnter(event)">
                        <button class="btn-icon btn-search" id="searchBtn" onclick="performDirectSearch()"><i
                                class="fas fa-search"></i></button>
                    </div>

                    <div id="geofenceMap" class="dark-theme-map"></div>
                </div>

            </section>

            <div class="glass-card ">
                <h3 class="card-heading" style="margin-left: 10px;">Client Insights</h3>
                <table class="simple-table">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Campaigns</th>
                            <th>Leads</th>
                            <th>Conv. Rate</th>
                            <th>Location</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Acme corp</td>
                            <td>5</td>
                            <td>500</td>
                            <td>12.50%</td>
                            <td>Mehsana</td>
                        </tr>
                        <tr>
                            <td>TechStart Inc</td>
                            <td>34</td>
                            <td>450</td>
                            <td>15.30%</td>
                            <td>Patan</td>
                        </tr>
                        <tr>
                            <td>FitLife Gym</td>
                            <td>45</td>
                            <td>650</td>
                            <td>10.40%</td>
                            <td>Ahmedabad</td>
                        </tr>
                        <tr>
                            <td>Luxury Stays</td>
                            <td>26</td>
                            <td>310</td>
                            <td>11.34%</td>
                            <td>Gandhinagar</td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </main>
    </div>

    <!-- Logut Model Logic -->
    <div class="modal-overlay1" id="logoutModal">
        <div class="modal-content1">
            <div class="modal-icon-box2">
                <i class="fa-solid fa-arrow-right-from-bracket"></i>
            </div>
            <h2>Ready to Leave?</h2>
            <p>Are you sure you want to logout? You will need to login again to access your dashboard.</p>
            <div class="modal-actions1">
                <button class="btn-modal1 btn-modal-cancel1" onclick="closeLogoutModal()">Cancel</button>
                <button class="btn-modal1 btn-modal-delete1" onclick="confirmLogout()">Logout</button>
            </div>
        </div>
    </div>

    <script src="Js/jquery-3.7.1.min.js"></script>
    <script src="Js/allagency.js"></script>

    <script>
        $(document).ready(function () {
            $("#statcard1").click(function (e) { e.preventDefault(); window.location.href = "Campaigns.html"; });
            $("#statcard2").click(function (e) { e.preventDefault(); window.location.href = "Leads.html"; });
            $("#statcard3").click(function (e) { e.preventDefault(); window.location.href = "Clients.html"; });
            $("#statcard4").click(function (e) { e.preventDefault(); window.location.href = "Report&Analytics.html"; });
        });

        const ctxPie = document.getElementById('sourceChart').getContext('2d');
        const sourceChart = new Chart(ctxPie, {
            type: 'pie',
            data: {
                labels: ['Google Ads', 'Facebook', 'Instagram', 'Whatsapp'],
                datasets: [{
                    data: [74, 17, 34, 49],
                    backgroundColor: ['#00ffaa', '#ffcc00', '#ff6b6b', '#00d4ff'],
                    borderWidth: 0, hoverOffset: 4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });


        let map;
        let autocomplete;
        let drawingManager;
        let currentMarker;

        function initMap() {
            // 1. Google Map Initialize karein
            map = new google.maps.Map(document.getElementById("geofenceMap"), {
                center: { lat: 20.5937, lng: 78.9629 },
                zoom: 5,
                styles: [
                    { elementType: "geometry", stylers: [{ color: "#091815" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#091815" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
                    {
                        featureType: "administrative.locality",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#d59563" }],
                    },
                    {
                        featureType: "poi",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#d59563" }],
                    },
                    {
                        featureType: "poi.park",
                        elementType: "geometry",
                        stylers: [{ color: "#263c3f" }],
                    },
                    {
                        featureType: "poi.park",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#6b9a76" }],
                    },
                    {
                        featureType: "road",
                        elementType: "geometry",
                        stylers: [{ color: "#38414e" }],
                    },
                    {
                        featureType: "road",
                        elementType: "geometry.stroke",
                        stylers: [{ color: "#212a37" }],
                    },
                    {
                        featureType: "road",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#9ca5b3" }],
                    },
                    {
                        featureType: "road.highway",
                        elementType: "geometry",
                        stylers: [{ color: "#746855" }],
                    },
                    {
                        featureType: "road.highway",
                        elementType: "geometry.stroke",
                        stylers: [{ color: "#1f2835" }],
                    },
                    {
                        featureType: "road.highway",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#f3d19c" }],
                    },
                    {
                        featureType: "transit",
                        elementType: "geometry",
                        stylers: [{ color: "#2f3948" }],
                    },
                    {
                        featureType: "transit.station",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#d59563" }],
                    },
                    {
                        featureType: "water",
                        elementType: "geometry",
                        stylers: [{ color: "#17263c" }],
                    },
                    {
                        featureType: "water",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#515c6d" }],
                    },
                    {
                        featureType: "water",
                        elementType: "labels.text.stroke",
                        stylers: [{ color: "#17263c" }],
                    },
                ]

            });

            // 2. Google Search (Autocomplete) Setup
            const input = document.getElementById("customSearchInput");
            autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.bindTo("bounds", map);

            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (!place.geometry || !place.geometry.location) {
                    alert("Location nahi mili!");
                    return;
                }
                if (place.geometry.viewport) {
                    map.fitBounds(place.geometry.viewport);
                } else {
                    map.setCenter(place.geometry.location);
                    map.setZoom(17);
                }
                if (currentMarker) currentMarker.setMap(null);
                currentMarker = new google.maps.Marker({
                    position: place.geometry.location,
                    map: map,
                    title: place.name
                });
            });

            // 3. Drawing Manager (Geofence tools)
            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: null,
                drawingControl: false,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: [
                        google.maps.drawing.OverlayType.CIRCLE,
                        google.maps.drawing.OverlayType.POLYGON,
                        google.maps.drawing.OverlayType.RECTANGLE,
                    ],
                },
                circleOptions: {
                    fillColor: "#00ffaa",
                    fillOpacity: 0.2,
                    strokeWeight: 2,
                    strokeColor: "#00ffaa",
                    clickable: true,
                    editable: true,
                    zIndex: 1,
                },
            });
            drawingManager.setMap(map);
        }

        window.onload = initMap;

        function handleEnter(e) {
            if (e.key === 'Enter') {

            }
        }


        $(document).ready(function () {
            let clientsData = [];
            let campaignsData = [];

            // 1. Backend se data load karein
            function loadGlobalData() {
                $.get("http://localhost:8080/api/agency/clients/all", function (data) {
                    clientsData = data;
                });
                $.get("http://localhost:8080/api/agency/campaigns/all?filter=all", function (data) {
                    campaignsData = data;
                });
            }
            loadGlobalData();

            // 2. Search Input Event
            $("#globalSearchInput").on("input", function () {
                let query = $(this).val().toLowerCase().trim();
                let suggestionBox = $("#globalSuggestionList");
                suggestionBox.empty();

                if (query.length < 1) {
                    suggestionBox.hide();
                    return;
                }

                // Filter Clients
                let filteredClients = clientsData.filter(c =>
                    (c.clientName || "").toLowerCase().includes(query)
                );

                // Filter Campaigns
                let filteredCampaigns = campaignsData.filter(cp =>
                    (cp.campaignName || "").toLowerCase().includes(query)
                );

                // UI mein add karein
                if (filteredClients.length > 0 || filteredCampaigns.length > 0) {

                    // Clients dikhayein
                    filteredClients.forEach(c => {
                        suggestionBox.append(`
                    <li class="suggestion-item" onclick="location.href='ClientDetails.html?id=${c.id}'">
                        <span><i class="fa-solid fa-user" style="margin-right:8px"></i> ${c.clientName}</span>
                        <span class="type-badge type-client">Client</span>
                    </li>
                `);
                    });

                    // Campaigns dikhayein
                    filteredCampaigns.forEach(cp => {
                        suggestionBox.append(`
                    <li class="suggestion-item" onclick="location.href='CampaignDetails.html?id=${cp.id}'">
                        <span><i class="fa-solid fa-bullhorn" style="margin-right:8px"></i> ${cp.campaignName}</span>
                        <span class="type-badge type-campaign">Campaign</span>
                    </li>
                `);
                    });

                    suggestionBox.show();
                } else {
                    suggestionBox.hide();
                }
            });

            // Suggestion box ke bahar click karne par hide karein
            $(document).on("click", function (e) {
                if (!$(e.target).closest('.search-bar').length) {
                    $("#globalSuggestionList").hide();
                }
            });
        });

    </script>
</body>

</html>